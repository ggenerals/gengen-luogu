<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云剪切版 · GenGen 洛谷国际</title>
    <!-- 共用 favicon & 主样式表 (深色玻璃变量 + 侧边栏 + 基础框架) -->
    <link rel="icon" href="https://luogu.qzz.io/lgge.svg">
    <link rel="stylesheet" href="https://luogu.qzz.io/style.css">
    <!-- GitHub Markdown 深色主题 + 代码高亮深色 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-dark.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
    <!-- 导入highlight-->
     <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script src="https://gengen.qzz.io/js/lgge-chat.js"></script>
    <!-- KaTeX 样式 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/16.3.0/lib/marked.umd.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/dompurify/3.2.7/purify.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
</head>
<body>
    <!-- 侧边栏 (与主页一致，云剪切版项 active) -->
    <div class="sidebar-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://luogu.qzz.io/lgge.svg" class="sidebar-logo" alt="logo">
                <span class="sidebar-title">GenGen 洛谷国际</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house size-5 shrink-0" aria-hidden="true"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"></path><path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg></span>
                    <span class="text">首页</span>
                </a>
                <a href="/article" class="nav-item">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-newspaper-icon lucide-newspaper"><path d="M15 18h-5"/><path d="M18 14h-8"/><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-4 0v-9a2 2 0 0 1 2-2h2"/><rect width="8" height="4" x="10" y="6" rx="1"/></svg></span>
                    <span class="text">文章</span>
                </a>
                <a href="/paste" class="nav-item active">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-pen-line-icon lucide-clipboard-pen-line"><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-.5"/><path d="M16 4h2a2 2 0 0 1 1.73 1"/><path d="M8 18h1"/><path d="M21.378 12.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/></svg></span>
                    <span class="text">云剪切板</span>
                </a>
            </nav>
        </aside>
    </div>

    <!-- 主区域 (顶栏 + 动态内容) -->
    <div class="main">
        <!-- 顶栏 (面包屑) 宽度已修复为100% -->
        <header class="topbar">
            <nav class="breadcrumb">
                <ol>
                    <li><a href="/">首页</a></li>
                    <li class="separator">/</li>
                    <li><a href="/article">云剪切版</a></li>
                    <li class="separator">/</li>
                    <li class="breadcrumb-item">
                        <span class="breadcrumb-current" id="breadcrumb-current">加载中...</span>
                    </li>
                </ol>
            </nav>
        </header>

        <!-- 内容区域: 左侧留白 + 云剪切版主体 + 右侧固定面板 -->
        <div class="content">
            <!-- 左侧预留空白 300px -->
            <div class="article-left"></div>

            <!-- 云剪切版主体 (中间区域) -->
            <div class="article-middle">
                <div class="article-header">
                    <h1 class="article-title" id="dynamic-article-title">加载云剪切版...</h1>
                    <div class="article-author">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'%3E%3Ccircle cx='19' cy='19' r='17' fill='%23333f5a'/%3E%3C/svg%3E" class="author-avatar" id="author-avatar" alt="作者头像">
                        <a href="#" class="author-name" id="author-link" target="_blank">加载中</a>
                    </div>
                </div>

                <!-- Markdown 渲染区 -->
                <div class="markdown-body" id="markdown-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在加载云剪切版内容...</p>
                    </div>
                </div>
            </div>

            <!-- 右侧面板：目录 + 保存时间 + 三个按钮 -->
            <div class="article-right">
                <!-- 保存时间 (分为两行) -->
                <div class="save-time" id="save-time">
                    <span class="label">当前云剪切版保存于</span>
                    <span class="value">--</span>
                </div>

                <!-- 云剪切版目录 -->
                <div class="toc-container">
                    <div class="toc-title">目录</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </div>

                <!-- 三个操作按钮 (纯文本) -->
                <div class="action-buttons">
                    <button class="action-btn" id="update-btn">更新内容</button>
                    <button class="action-btn" id="original-btn" disabled>访问原文</button>
                    <button class="action-btn" id="copy-btn" disabled>复制 MD</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        (async function() {
            // ---------- 确保 hljs 存在 ----------
            if (typeof hljs === 'undefined') {
                console.warn('hljs 未加载，代码高亮已禁用');
                window.hljs = {
                    highlight: (code) => ({ value: code }),
                    highlightElement: (el) => {}
                };
            }

            // ---------- 增强扩展语法处理 (支持标题和属性) ----------
            function preprocessMarkdownExtensions(raw) {
                if (!raw) return raw;
                // 匹配 :::type[可选标题]{可选属性} 内容 :::  (允许跨行)
                const alertRegex = /:::(\w+)(?:\[([^\]]*)\])?(?:\{([^}]*)\})?\s*\n([\s\S]*?)\n:::/g;
                raw = raw.replace(alertRegex, (match, type, title, attrs, content) => {
                    const safeType = type.toLowerCase();
                    const titleHtml = title ? `<div class="markdown-alert-title">${title.trim()}</div>` : '';
                    return `<div class="markdown-alert markdown-alert-${safeType}">${titleHtml}<div class="markdown-alert-content">${content.trim()}</div></div>`;
                });

                // 同时兼容简单语法 :::type 内容 :::
                const simpleTypes = ['error','warning','note','success','info','tip','caution','important'];
                simpleTypes.forEach(t => {
                    const simpleRegex = new RegExp(`:::${t}\\s*\\n([\\s\\S]*?)\\n:::`, 'g');
                    raw = raw.replace(simpleRegex, (match, content) => {
                        return `<div class="markdown-alert markdown-alert-${t}"><div class="markdown-alert-content">${content.trim()}</div></div>`;
                    });
                });

                // 对齐语法
                raw = raw.replace(/:::align\{center\}\s*\n([\s\S]*?)\n:::/g, (match, content) => {
                    return `<div class="markdown-align-center">${content.trim()}</div>`;
                });
                raw = raw.replace(/:::align\{right\}\s*\n([\s\S]*?)\n:::/g, (match, content) => {
                    return `<div class="markdown-align-right">${content.trim()}</div>`;
                });
                return raw;
            }

            // ---------- 获取云剪切版 ID ----------
            let articleId = null;
            const path = window.location.pathname;
            const pathMatch = path.match(/\/paste\/([a-z0-9]+)/);
            if (pathMatch) articleId = pathMatch[1];
            if (!articleId && window.location.hash) articleId = window.location.hash.replace(/^#/, '').trim();
            if (!articleId) {
                const params = new URLSearchParams(window.location.search);
                articleId = params.get('id');
            }


            if (!articleId || articleId.length < 3) {
                articleId='yx7hyde9';
            }

            document.getElementById('breadcrumb-current').innerText = `ID: ${articleId}`;

            // ---------- 设置 marked ----------
            marked.setOptions({
                gfm: true,
                breaks: true,
                smartypants: true,
                highlight: (code, lang) => {
                    const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language: validLang }).value;
                }
            });

            // ---------- DOM 元素 ----------
            const titleEl = document.getElementById('dynamic-article-title');
            const authorAvatar = document.getElementById('author-avatar');
            const authorLink = document.getElementById('author-link');
            const saveTimeEl = document.getElementById('save-time');
            const originalBtn = document.getElementById('original-btn');
            const copyBtn = document.getElementById('copy-btn');
            const updateBtn = document.getElementById('update-btn');
            const markdownBody = document.getElementById('markdown-content');
            const tocList = document.getElementById('toc-list');
            const breadcrumbSpan = document.getElementById('breadcrumb-current');

            // ---------- 加载云剪切版数据 ----------
            async function loadArticle(forceUpdate = false) {
                let apiUrl = `https://luogu.qzz.io/api/p/${articleId}`;
                if (forceUpdate) {
                    apiUrl += '?update=1';
                }

                try {
                    const resp = await fetch(apiUrl, { mode: 'cors' });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    const data = await resp.json();
                    if (!data.success || data.type !== 'paste') {
                        throw new Error(data.message || '无效的云剪切版数据');
                    }

                    data.title=data.author.name+"的云剪切版";
                    // 更新标题 & 面包屑
                    titleEl.innerText = data.title;
                    document.title = `${data.title} - GenGen 洛谷国际`;
                    breadcrumbSpan.innerText = data.title;

                    // 作者信息
                    authorAvatar.src = `https://cdn.luogu.com.cn/upload/usericon/${data.author.uid}.png`;
                    authorLink.href = `https://luogu.store/u/${data.author.uid}`;
                    authorLink.innerText = data.author.name;

                    // 保存时间
                    const ts = data.updated_at > 1e12 ? data.updated_at : data.updated_at * 1000;
                    const d = new Date(ts);
                    const formatted = d.toLocaleString('zh-CN', { 
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        hour12: false 
                    }).replace(/\//g, '-').replace(',', '');
                    saveTimeEl.querySelector('.value').innerText = formatted;

                    // 启用按钮
                    originalBtn.disabled = false;
                    copyBtn.disabled = false;

                    originalBtn.onclick = () => {
                        if (data.original_url) window.open(data.original_url.trim(), '_blank');
                    };

                    copyBtn.onclick = async () => {
                        try {
                            await navigator.clipboard.writeText(data.content);
                            const old = copyBtn.innerText;
                            copyBtn.innerText = '已复制';
                            copyBtn.disabled = true;
                            setTimeout(() => {
                                copyBtn.innerText = old;
                                copyBtn.disabled = false;
                            }, 1500);
                        } catch {
                            alert('复制失败，请手动复制');
                        }
                    };

                    // ---------- 预处理扩展语法 ----------
                    let processedContent = preprocessMarkdownExtensions(data.content);

                    // 渲染 Markdown
                    const rawHtml = marked.parse(processedContent);
                    // 确保图片正常显示：DOMPurify 默认允许 img，但显式配置更安全
                    const cleanHtml = DOMPurify.sanitize(rawHtml, { 
                        ADD_TAGS: ['span', 'div', 'math'], 
                        ADD_ATTR: ['class', 'src', 'alt'],   // 明确保留 src 和 alt
                        ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i // 允许 http/https
                    });
                    markdownBody.innerHTML = cleanHtml;

                    // 渲染数学公式
                    renderMathInElement(markdownBody, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false
                    });

                    // 代码高亮
                    markdownBody.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                    });

                    // ---------- 生成目录 ----------
                    const headers = markdownBody.querySelectorAll('h1, h2, h3');
                    if (headers.length > 0) {
                        tocList.innerHTML = '';
                        headers.forEach((h, index) => {
                            const level = parseInt(h.tagName[1]);
                            let text = h.innerText;
                            if (!h.id) {
                                h.id = `toc-header-${index}`;
                            }
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = `#${h.id}`;
                            a.innerText = text;
                            a.classList.add(`toc-h${level}`);
                            li.appendChild(a);
                            tocList.appendChild(li);
                        });
                    } else {
                        tocList.innerHTML = '<li style="color: var(--text-muted);">无标题</li>';
                    }

                } catch (err) {
                    console.error('加载失败:', err);
                    titleEl.innerText = '加载失败';
                    markdownBody.innerHTML = `<div class="error-message">错误：${err.message}</div>`;
                    breadcrumbSpan.innerText = '错误';
                }
            }

            // 首次加载
            await loadArticle(false);

            // 更新按钮：强制重新加载
            updateBtn.onclick = () => {
                markdownBody.innerHTML = '<div class="loading"><div class="spinner"></div><p>更新中...</p></div>';
                loadArticle(true);
            };
        })();
    </script>
</body>
</html>